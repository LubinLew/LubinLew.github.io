# 发布

应用程序升级面临最大挑战是新旧业务切换，将软件从测试的最后阶段带到生产环境，同时要保证系统不间断提供服务。

长期以来，业务升级渐渐形成了几个发布策略：蓝绿发布、灰度发布和滚动发布，目的是尽可能避免因发布导致的流量丢失或服务不可用问题。

### 金丝雀发布/灰度发布

金丝雀发布(canary release)又叫灰度发布，灰度是指在黑与白之间，能够平滑过渡的一种发布方式。简单来讲，一个产品，需要快速迭代开发上线，一方面要保证质量，另一方面保证刚上线的系统，这时候就需要设计一套灰度发布系统，让一部分用户继续使用产品A，另一部用户使用产品B，一旦出现问题可以很快的控制影响，如果用户对B没有什么反对意见，那么逐步扩大范围，把所有用户都迁移到B上面来。'

#### 特点

- 保证整体系统稳定性，在初始灰度的时候就可以发现、调整问题，影响范围可控；

- 新功能逐步评估性能，稳定性和健康状况，如果出问题影响范围很小，相对用户体验也少；

- 用户无感知，平滑过渡。

#### 缺点

- 自动化要求高



> 为什么叫金丝雀发布（Canary）？以前，旷工开矿，在下矿洞前需要检查下方是否有毒气，矿工们先会放一只金丝雀进去探是否有有毒气体，看金丝雀能否活下来。

----

### 蓝绿发布

项目逻辑上分为AB组，在项目升级时，首先把A组从负载均衡中摘除，进行新版本的部署。B组仍然继续提供服务。当A组升级完毕，负载均衡重新接入A组，再把B组从负载列表中摘除，进行新版本的部署。A组重新提供服务。最后，B组也升级完成，负载均衡重新接入B组，此时，AB组版本都已经升级完成，并且都对外提供服务。

#### 特点

- 如果出问题，影响范围较大；

- 发布策略简单；

- 用户无感知，平滑过渡；

- 升级/回滚速度快。

#### 缺点

- 需要准备正常业务使用资源的两倍以上服务器，防止升级期间单组无法承载业务突发；

- 短时间内浪费一定资源成本；

- 基础设施无改动，增大升级稳定性。

---

### 滚动发布

滚动发布是指每次只升级一个或多个服务(从LB上下架)，升级完成后加入生产环境(在LB上上架)，不断执行这个过程，直到集群中的全部旧版本升级新版本。

#### 特点

- 用户无感知，平滑过渡；

- 节约资源。

#### 缺点

- 部署时间慢，取决于每阶段更新时间；

- 发布策略较复杂；

- 无法确定OK的环境，不易回滚。



----

### References

[一文搞懂蓝绿发布、灰度发布和滚动发布 - 努力哥](https://www.cnblogs.com/nulige/articles/10929182.html)

[什么是蓝绿发布？ - 简书](https://www.jianshu.com/p/1ab0d2f86c11)

https://www.zhihu.com/question/335832790

# 获取真实客户端IP地址

通常一个客户端请求到达真实服务器需要经过1次或者多次的反向代理，这些反向代理可能是负载均衡或者安全过滤等。但是很多服务端/安全过滤设备都需要知道真实的客户端IP地址，用于数据统计或者反CC/爬虫等。

当前HTTP请求的客户端的真实IP地址主要从三个途径获取：

- TCP链接的远端地址

- HTTP请求头中的  `X-Real-IP` 字段

- HTTP请求头中的 `X-Forward-For` 字段

如果服务器前有反向代理，TCP链接中获取的远端地址就是离他最近的反向代理服务器的地址。

## X-Real-IP 和 X-Forward-For 的区别

`X-Real-IP` 表示客户端的真实的 IP 地址，这个参数**没有相关标准规范**，如果是直接访问的请求，可能是客户端真实的 IP 地址，但是中间若经过了层层的代理，就是最后一层代理的 IP 地址。

`X-Forwarded-For`记录着从客户端发起请求后访问过的每一个 IP 地址，当然第一个是发起请求的客户端本身的地址，各 IP 地址间由“英文逗号+空格”(`,`)分隔。

相对于 `X-Real-IP` 的不确定性，`X-Forwarded-For` 已经写进了 [RFC 7239](http://tools.ietf.org/html/rfc7239)，所以成了获取 IP 地址的首选途径。

> 参考 [X-Real-IP 与 X-Forwarded-For &#8211; 不知不问](https://blog.mazey.net/1575.html)

## 如何获取真实的客户端IP地址

由于这两个字段攻击者可以随意伪造， 如果完全按照上面的方法去获取真实的客户端IP，那么Web攻击、爬虫 等等都可以轻松绕过一些基于请求频率的安全设置。

首先，我们需要知道该真实服务器前，受信任的反向代理设备的IP地址(例如CDN、高防IP等设备)列表。那么离真实服务器最远的代理设备IP地址前一个地址就认定为真实客户端IP，因为这是绝对可信的，再往前则是可能任意构造的。

ngx.var 的性能提升

首先让我们来看一个 C 模块：lua-var-nginx-module。前面我曾经提到过，**ngx.var 是一个性能损耗比较大的操作，在实际使用时，我们需要用 ngx.ctx 来做一层缓存**。那有没有什么方法，可以彻底解决 ngx.var 的性能问题呢？这个 C 模块，就在这个方面做了一些尝试，效果也很显著，性能比起ngx.var 提升了 5 倍。它采用的是 FFI 的方式，所以，你需要在编译 OpenResty 的时候，先加上编译选项：



table 

尽量复用，避免不必要的 table 创建。

预先生成数组,每次新增和删除数组元素的时候，都会涉及到数组的空间分配、resize 和 rehash。LuaJIT 中的 table.new(narray, nhash) 函数，就是因此而新增的。这个函数，会预先分配好指定的数组和哈希的空间大小，而不是在插入元素时自增长，这也是它的两个参数 narray 和 nhash 的含义。



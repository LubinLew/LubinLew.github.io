# Exported Perl Functions

The following Perl functions are exported by default:

[run_tests](https://metacpan.org/pod/Test::Nginx::Socket#run_tests)

**测试框架的入口点**. 在 `__DATA__` 前调用该函数就会开启测试。其他配置类的Perl函数必须在这个函数之前调用。

[no_shuffle](https://metacpan.org/pod/Test::Nginx::Socket#no_shuffle)

默认情况下，测试框架会自动打乱测试case的执行顺序。在 `run_tests` 之前调用该函数则不会打乱测试case的执行程序。

[use_hup](https://metacpan.org/pod/Test::Nginx::Socket#use_hup)

Calling this function before calling `run_tests` will make the current test scaffold behave as if `TEST_NGINX_USE_HUP` was set to 1.

[no_long_string](https://metacpan.org/pod/Test::Nginx::Socket#no_long_string)

By default, failed string equality test will use the [Test::LongString](https://metacpan.org/pod/Test::LongString) module to generate the error message. Calling this function before calling `run_tests` will turn this off.

[no_diff](https://metacpan.org/pod/Test::Nginx::Socket#no_diff)

When the `no_long_string` function is called, the `Text::Diff` module will be used to generate a diff for failed string equality test. Calling this `no_diff` function before calling `run_tests` will turn this diff output format off and just generate the raw "got" text and "expected" text.

[worker_connections](https://metacpan.org/pod/Test::Nginx::Socket#worker_connections)

设置Nginx的 `worker_connections` 配置，例子如下：

```perl
worker_connections(1024);
run_tests();
```

默认值是 64，`run_tests()`前调用。

[repeat_each](https://metacpan.org/pod/Test::Nginx::Socket#repeat_each)

调用该函数带一个整型参数，这个整型参数是要求测试框架对当前测试文件中的每一个测试case重复测试的次数。当不带参数调用这个函数时， 返回当前设定的值。

默认值是 1，`run_tests()`前调用。

[shutdown_error_log](https://metacpan.org/pod/Test::Nginx::Socket#shutdown_error_log)

You can use this section to check the error log generated during nginx exit.

For example,

`--- shutdown_error_log`

`cleanup resolver`

or an example for using an array value,

`--- shutdown_error_log` `eval`

`[``"cleanup"``,` `"resolver"``]`

**WARNING:** skip the shutdown_error_log tests under the HUP reload mode.

[no_shutdown_error_log](https://metacpan.org/pod/Test::Nginx::Socket#no_shutdown_error_log)

Very much like the `--- shutdown_error_log` section, but does the opposite test, i.e., pass only when the specified patterns of lines do not appear in the *error.log* file at all.

Here is an example:

`--- no_shutdown_error_log`

`[error]`

This test will fail when any of the line in the *error.log* file contains the string `"[error]"`.

[env_to_nginx](https://metacpan.org/pod/Test::Nginx::Socket#env_to_nginx)

Specify additional system environmnt variables to be passed into the nginx server.

For example,

`env_to_nginx(``"foo"``,` `"bar=123"``,` `"baz=hello world"``);`

`run_tests();`

will result in the following lines to be inserted into the resulting *nginx.conf* file generated by the test scaffold:

`env foo;`

`env bar=123;`

`env` `'baz=hello world'``;`

The latter two are examples of setting values directly to the environments. You can also set values directly on the Perl land, before calling this `env_to_nginx` function, for instance,

`$ENV``{baz} =` `'hello world'``;`

`env_to_nginx(``"baz"``);`

If you just want to pass certain environments to a particular test case (or test block), you can just use the `--- main_config` secion directly. For example,

`--- main_config`

`env foo;`

`env bar=123;`

You can check out nginx's official document on its `env` directive below:

[Core functionality](http://nginx.org/r/env)

By default, only the following environments are passed:

- MOCKEAGAIN_VERBOSE

- MOCKEAGAIN

- MOCKEAGAIN_WRITE_TIMEOUT_PATTERN

- LD_PRELOAD

- LD_LIBRARY_PATH

- DYLD_INSERT_LIBRARIES

- DYLD_FORCE_FLAT_NAMESPACE

- ASAN_OPTIONS

- MOCKNOEAGAIN_VERBOSE

- MOCKNOEAGAIN

[workers](https://metacpan.org/pod/Test::Nginx::Socket#workers)

Call this function before `run_tests()` to configure Nginx's `worker_processes` directive's value. For example,

`workers(2);`

Default to 1.

[master_on](https://metacpan.org/pod/Test::Nginx::Socket#master_on)

Call this function before `run_tests()` to turn on the Nginx master process.

By default, the master process is not enabled unless in the "HUP reload" testing mode.

[log_level](https://metacpan.org/pod/Test::Nginx::Socket#log_level)

Call this function before `run_tests()` to set the default error log filtering level in Nginx.

This global setting can be overridden by the per-test-block `--- log_level` sections.

默认值是  `debug`，`run_tests()`前调用。

[check_accum_error_log](https://metacpan.org/pod/Test::Nginx::Socket#check_accum_error_log)

Make `--- error_log` and `--- no_error_log` check accumulated error log across duplicate requests controlled by `repeat_each`. By default, only the error logs belonging to the individual `repeat_each` request is tested.

[no_root_location](https://metacpan.org/pod/Test::Nginx::Socket#no_root_location)

By default, the Nginx configuration file generated by the test scaffold automatically emits a `location /`. Calling this function before `run_tests()` disables this behavior such that the test blocks can have their own root locations.

[bail_out](https://metacpan.org/pod/Test::Nginx::Socket#bail_out)

Aborting the whole test session (not just the current test file) with a specified message.

This function will also do all the necessary cleanup work. So always use this function instead of calling `Test::More::BAIL_OUT()` directly.

For example,

`bail_out(``"something bad happened!"``);`

[add_cleanup_handler](https://metacpan.org/pod/Test::Nginx::Socket#add_cleanup_handler)

Rigister custom cleanup handler for the current perl/prove process by specifying a Perl subroutine object as the argument.

For example,

`add_cleanup_handler(``sub` `{`

 `kill` `INT` `=>` `$my_own_child_pid``;`

 `$my_own_socket``->``close``()`

`});`

[add_block_preprocessor](https://metacpan.org/pod/Test::Nginx::Socket#add_block_preprocessor)

Add a custom Perl preprocessor to each test block by specifying a Perl subroutine object as the argument.

The processor subroutine is always run right before processing the test block.

This mechanism can be used to add custom sections or modify existing ones.

For example,

`add_block_preprocessor(``sub` `{`

 `my` `$block` `=` `shift``;`

 `# use "--- req_headers" for "--- more_Headers":`

 `$block``->set_value(``"more_headers"``,` `$block``->req_headers);`

 `# initialize external dependencies like memcached services here...`

`});`

We can leverage this feature to specify a default value for one or more sections in a single test file. For instance,

`use` `[Test::Nginx::Socket](https://metacpan.org/pod/Test::Nginx::Socket)` `'no_plan'``;`

`add_block_preprocessor(``sub` `{`

 `my` `$block` `=` `shift``;`

 `if` `(!``defined` `$block``->config) {`

 `$block``->set_value(``"config"``,` `<<'_END_');`

`location = /t {`

 `echo $arg_a;`

`}`

`_END_`

 `}`

`});`

`run_tests();`

`__DATA__`

`=== TEST 1:`

`--- request`

 `GET /t?a=3`

`--- response_body`

`3`

`=== TEST 2:`

`--- request`

 `GET /t?a=blah`

`--- response_body`

`blah`

`=== TEST 3:`

`--- config`

 `location = /t {`

 `echo ok;`

 `}`

`--- request`

 `GET /t?a=blah`

`--- response_body`

`ok`

Here all the test blocks in this file have a default `--- config` section configured. Some of the test blocks can still specify its own `--- config` section to override the default, as in the `TEST 3` test block above.

You can also make the defaults applicable to all the test files. Just create a subclass of [Test::Nginx::Socket](https://metacpan.org/pod/Test::Nginx::Socket) (or one of its subclasses like [Test::Nginx::Socket::Lua](https://metacpan.org/pod/Test::Nginx::Socket::Lua), as in,

`package` `[t::MyTester](https://metacpan.org/pod/t::MyTester);`

`use` `[Test::Nginx::Socket](https://metacpan.org/pod/Test::Nginx::Socket) -Base;`

`add_block_preprocessor(``sub` `{`

 `my` `$block` `=` `shift``;`

 `if` `(!``defined` `$block``->config) {`

 `$block``->set_value(``"config"``,` `<<'_END_');`

`location = /t {`

 `echo $arg_a;`

`}`

`_END_`

 `}`

`});`

`1;`

Save this as file *t/MyTester.pm*. And then in one of your test file:

`use` `[t::MyTester](https://metacpan.org/pod/t::MyTester)` `'no_plan'``;`

`run_tests();`

`__DATA__`

`=== TEST 1:`

`--- request`

 `GET /t?a=3`

`--- response_body`

`3`

`=== TEST 2:`

`--- request`

 `GET /t?a=blah`

`--- response_body`

`blah`

You can do the same with the `--- http_config` section, or even inventing your own new sections. This is very powerful.

[add_response_body_check](https://metacpan.org/pod/Test::Nginx::Socket#add_response_body_check)

Add custom checks for testing response bodies by specifying a Perl subroutine object as the argument.

Below is an example for doing HTML title checks:

`add_response_body_check(``sub` `{`

 `my` `(``$block``,` `$body``,` `$req_idx``,` `$repeated_req_idx``,` `$dry_run``) =` `@_``;`

 `my` `$name` `=` `$block``->name;`

 `my` `$expected_title` `=` `$block``->resp_title;`

 `if` `(``$expected_title` `&& !``ref` `$expected_title``) {`

 `$expected_title` `=~ s/^\s*|\s*$//gs;`

 `}`

 `if` `(``defined` `$expected_title``) {`

 `SKIP: {`

 `skip` `"$name - resp_title - tests skipped due to $dry_run"``, 1` `if` `$dry_run``;`

 `my` `$title``;`

 `if` `(``$body` `=~ m{<\s``*title``\s*>\s*(.*?)<\s*/\s``*title``\s*>}) {`

 `$title` `= $1;`

 `$title` `=~ s/\s*$//s;`

 `}`

 `is_str(``$title``,` `$expected_title``,`

 `"$name - resp_title (req $repeated_req_idx)"` `);`

 `}`

 `}`

 `});`

[is_str](https://metacpan.org/pod/Test::Nginx::Socket#is_str)

Performs intelligent string comparison subtests which honors both `no_long_string` and regular expression references in the "expected" argument.
